version: 2.1

orbs:
  slack: circleci/slack@5.1.1
  scotty-orb: cci-releng/scotty-orb@0.0.12

executors:
  deploy:
    docker:
      - image: cimg/deploy:2025.01
    resource_class: medium
  ccc:
    docker:
      - image: circleci/command-convenience:0.1
        auth:
          username: $DOCKER_HUB_USER
          password: $DOCKER_HUB_PASSWORD

commands:
  notify_failing_main:
    steps:
      - slack/notify:
          channel: server-alerts
          branch_pattern: main
          event: fail
          template: basic_fail_1
  set_up_container:
    description: "Set up a container build environment"
    steps:
      - setup_remote_docker
      - checkout

jobs:
  validate-charts:
    executor: deploy
    steps:
      - checkout
      - run:
          command: ./do kubeconform
          when: always
      - notify_failing_main
  scan_postgresql:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Scan server-postgres image
          command: scan
          environment:
            NAME: server-postgres
            DOCKERFILE_PATH: Dockerfile
            MAJOR_VERSION: 12.22
          pwd: postgresql/12
  scan_rabbitmq:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Scan server-rabbitmq image
          command: scan
          environment:
            NAME: server-rabbitmq
            DOCKERFILE_PATH: Dockerfile
            MAJOR_VERSION: 3.12
          pwd: rabbitmq/3
  scan_redis:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Scan server-redis image
          command: scan
          environment:
            NAME: server-redis
            DOCKERFILE_PATH: Dockerfile
            MAJOR_VERSION: 6.2
          pwd: redis/6.2/debian-10
  publish_postgresql:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Build and publish server-postgres image
          command: publish
          environment:
            NAME: server-postgres
            DOCKERFILE_PATH: Dockerfile
            DOCKER_REGISTRY: dockerhub
            MAJOR_VERSION: 12.22
          pwd: postgresql/12
  publish_rabbitmq:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Build and publish server-rabbitmq image
          command: publish
          environment:
            NAME: server-rabbitmq
            DOCKERFILE_PATH: Dockerfile
            DOCKER_REGISTRY: dockerhub
            MAJOR_VERSION: 3.12
          pwd: rabbitmq/3
  publish_redis:
    executor: ccc
    steps:
      - set_up_container
      - run:
          name: Build and publish server-redis image
          command: publish
          environment:
            NAME: server-rabbitmq
            DOCKERFILE_PATH: Dockerfile
            DOCKER_REGISTRY: dockerhub
            MAJOR_VERSION: 6.2
          pwd: redis/6.2/debian-10

workflows:
  my-workflow:
    jobs:
      - validate-charts
      - scan_rabbitmq:
          context: "org-global"
          filters:
            branches:
              ignore:
                - main
                - /^server-\d\..+/
      - scan_postgresql:
          context: "org-global"
          filters:
            branches:
              ignore:
                - main
                - /^server-\d\..+/
      - scan_redis:
          context: "org-global"
          filters:
            branches:
              ignore:
                - main
                - /^server-\d\..+/
      - publish_rabbitmq:
          context: "org-global"
          filters:
            branches:
              only:
                - main
                - /^server-\d\..+/
      - publish_postgresql:
          context: "org-global"
          filters:
            branches:
              only:
                - main
                - /^server-\d\..+/
      - publish_redis:
          context: "org-global"
          filters:
            branches:
              only:
                - main
                - /^server-\d\..+/
      - scotty-orb/test-in-server-and-promote:
          name: test-in-server-and-promote
          context: "org-global"
          requires:
            - publish_rabbitmq
            - publish_postgresql
            - publish_redis
            - validate-charts
          promotion_component_list: "circleci/server-postgres circleci/server-rabbitmq circleci/server-redis"
          filters:
            branches:
              only:
                - main
                - /^server-\d\..+/
